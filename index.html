<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyrama Leaderboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Skyrama Leaderboard</h1>
    <table id="leaderboard">
        <thead>
            <tr>
                <th>Name</th>
                <th>ID</th>
                <th>Last Online</th>
                <th>Level</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be inserted here by JavaScript -->
        </tbody>
    </table>

    <script>
        // XP required to advance from one level to the next
        const xpToNextLevel = [
            15, 20, 25, 40, 65, 100, 155, 225, 315, 435, 600, 800, 1075, 1415, 1835, 2345, 
            2950, 3650, 4425, 5300, 6300, 7350, 8525, 9785, 11150, 12600, 14200, 15850, 
            17600, 19500, 21500, 23500, 25750, 28000, 30500, 33000, 35600, 38500, 41000, 
            44000, 47000, 50500, 54000, 57500, 61000, 65000, 73500, 78000, 83000, 88500, 
            94000, 100000, 106000, 113000, 120000, 128000, 135000, 145000, 155000, 167000, 
            182000, 200000, 225000, 260000, 315000, 395000, 510000, 690000, 960000, 
            1400000, 2050000, 3150000, 5000000, 7800000, 11800000, 17600000, 26000000, 
            38235000, 52960000, 72220000, 100822000, 131700000, 175600000, 233360000, 
            308700000, 407820000, 535260000, 700000000, 934600000, 1200000000, 1500000000, 
            1900000000, 2400000000, 3000000000, 3500000000, 4000000000, 4500000000, 
            5000000000, 6000000000
        ];

        // Calculate cumulative XP for each level
        const cumulativeXP = [];
        let totalXP = 0;
        for (let i = 0; i < xpToNextLevel.length; i++) {
            totalXP += xpToNextLevel[i];
            cumulativeXP.push(totalXP);
        }

        function getLevel(xp) {
            for (let i = cumulativeXP.length - 1; i >= 0; i--) {
                if (xp >= cumulativeXP[i]) {
                    return i + 2;
                }
            }
            return 0; // Level 0 if XP is below the first level's requirement
        }

        function formatRelativeTime(timestamp) {
            const now = Date.now();
            const lastOnlineDate = new Date(timestamp * 1000);
            const diff = now - lastOnlineDate.getTime(); // Difference in milliseconds

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);

            if (days <= 7) {
                return 'in the last 7 days';
            } else if (days <= 30) {
                return 'in the last 30 days';
            } else if (days <= 180) {
                return 'in the last 6 months';
            } else if (days <= 365) {
                return 'in the last year';
            } else {
                return `in the last ${years} year${years > 1 ? 's' : ''}`;
            }
        }

        // Location mapping
        const locationMap = {
            2: 'Germany',
            3: 'Turkey'
        };

        async function loadLeaderboard() {
            try {
                // Fetch the JSON data
                const response = await fetch('data.json');
                const data = await response.json();

                // Sort data by XP in descending order
                data.sort((a, b) => b.xp - a.xp);

                // Reference to the table body
                const tableBody = document.querySelector('#leaderboard tbody');

                // Iterate over the sorted data and create table rows
                data.forEach(player => {
                    // Convert timestamp to a relative time format
                    const lastOnlineRelative = formatRelativeTime(player.last_ping_time);

                    // Determine the player's level
                    const level = getLevel(player.xp);

                    // Get the location name from the locationMap
                    const location = locationMap[player.location_id] || 'Unknown';

                    // Create a new row
                    const row = document.createElement('tr');

                    // Insert cells into the row
                    row.innerHTML = `
                        <td>${player.username}</td>
                        <td>${player.hi_player_id}</td>
                        <td>${lastOnlineRelative}</td>
                        <td>${level}</td>
                        <td>${location}</td>
                    `;

                    // Append the row to the table body
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading leaderboard data:', error);
            }
        }

        // Load the leaderboard data when the page is loaded
        window.onload = loadLeaderboard;
    </script>
</body>
</html>
